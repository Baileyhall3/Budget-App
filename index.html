<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Budget Planner</title>
        <link rel="stylesheet" href="styling.css">
        <link rel ="icon" type="image/x-icon" href="images/money-bag.png">
        <script src="scripts/navbar-loader.js" defer></script>
    </head>
<body>
<div id="navbar-placeholder"></div>
<div class="wrapper">
    <div class="container">
        <div class="content">
            <div class="header-container">
                <h5 style="font-size: 24px;" id="title-display">Dashboard</h5>
            </div>
        </div>
    </div>
</div>


<script>
    // Initialize variables
    let potTitle = "";
    let totalAmount = 2000;
    let items = [];
    let draggedIndex = null;

    // Get DOM elements
    const totalDisplay = document.getElementById('total-display');
    const titleDisplay = document.getElementById('title-display');
    const moneyBar = document.getElementById('money-bar');
    const itemList = document.getElementById('item-list');
    const totalInput = document.getElementById('total-amount');
    const titleInput = document.getElementById('pot-title');
    const toggleLabelsCheckbox = document.getElementById('toggle-labels');
    const toggleRemainingCheckbox = document.getElementById('toggle-remaining');

    // Function to update localStorage
    const saveToLocalStorage = () => {
        const data = {
            potTitle,
            totalAmount,
            items
        };
        localStorage.setItem('budgetData', JSON.stringify(data));
    };

    // Function to load data from localStorage
    const loadFromLocalStorage = () => {
        const savedData = localStorage.getItem('budgetData');
        if (savedData) {
            const { potTitle: savedTitle, totalAmount: savedTotal, items: savedItems } = JSON.parse(savedData);
            potTitle = savedTitle || "";
            totalAmount = savedTotal || 2000;
            items = savedItems || [];
            totalInput.value = totalAmount;
            titleInput.value = potTitle;
        }
    };

    // Function to update the display and sort items
    const updateDisplay = () => {
        moneyBar.innerHTML = '';
        itemList.innerHTML = '';

        let totalSpent = items.reduce((sum, item) => sum + item.amount, 0);
        titleDisplay.innerText = potTitle;
        totalDisplay.innerText = `Total = £${totalSpent} out of £${totalAmount}`;

        // Sort items by the sort order
        const sortedItems = items.slice().sort((a, b) => a.sort - b.sort);

        // Adjust total for remaining amount if the toggle is checked
        let availableWidth = 100;  // We'll use this as the total width (100%)

        // If 'Show Remaining' is unchecked, distribute 100% width among the items
        if (!toggleRemainingCheckbox.checked || totalSpent >= totalAmount) {
            availableWidth = 100;
        } else {
            availableWidth = (totalSpent / totalAmount) * 100;
        }

        sortedItems.forEach((item, index) => {
            const potDiv = document.createElement('div');
            const itemWidthPercentage = (item.amount / totalSpent) * availableWidth;

            potDiv.style.width = itemWidthPercentage + '%';
            potDiv.classList.add('money-pot');
            potDiv.style.backgroundColor = item.color;
            potDiv.draggable = true; 
            potDiv.setAttribute('data-index', index);

            const labelDiv = document.createElement('div');
            labelDiv.classList.add('actual-value');
            labelDiv.innerText = `${item.name} (£${item.amount})`;

            if (!toggleLabelsCheckbox.checked) {
                labelDiv.style.display = 'none';
            }
            potDiv.appendChild(labelDiv);
            moneyBar.appendChild(potDiv);

            const deleteBtn = document.createElement('span');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.innerHTML = 'X';
            deleteBtn.onclick = () => {
                items.splice(index, 1); 
                updateDisplay();
                saveToLocalStorage(); // Save after removing item
            };

            const listItem = document.createElement('li');
            listItem.innerText = `${item.name} (£${item.amount})`;
            listItem.appendChild(deleteBtn);
            itemList.appendChild(listItem);

            // Drag events
            potDiv.addEventListener('dragstart', (e) => {
                draggedIndex = index;
                e.dataTransfer.effectAllowed = "move";
                potDiv.style.opacity = "0.5";
            });

            potDiv.addEventListener('dragend', () => {
                potDiv.style.opacity = "1";
            });

            potDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
            });

            potDiv.addEventListener('drop', (e) => {
                const targetIndex = parseInt(e.target.getAttribute('data-index'));

                // Swap the sort values to change positions
                if (draggedIndex !== null && draggedIndex !== targetIndex) {
                    [items[draggedIndex].sort, items[targetIndex].sort] = [items[targetIndex].sort, items[draggedIndex].sort];
                    updateDisplay(); 
                    saveToLocalStorage(); // Save after reordering
                }
                draggedIndex = null;
            });
        });

        // Add the remaining bar if there's remaining amount and 'Show Remaining' is checked
        const remainingAmount = totalAmount - totalSpent;
        if (remainingAmount > 0 && toggleRemainingCheckbox.checked) {
            const remainingDiv = document.createElement('div');
            const remainingWidthPercentage = (remainingAmount / totalAmount) * 100;
            remainingDiv.style.width = remainingWidthPercentage + '%';
            remainingDiv.classList.add('money-pot', 'remaining');

            const labelDiv = document.createElement('div');
            labelDiv.classList.add('actual-value');
            labelDiv.innerText = `Remaining (£${remainingAmount})`;
            if (!toggleLabelsCheckbox.checked) {
                labelDiv.style.display = 'none';
            }

            remainingDiv.appendChild(labelDiv);
            moneyBar.appendChild(remainingDiv);
        }
    };

    // Handle adding new items
    document.getElementById('add-item').addEventListener('click', () => {
        const itemName = document.getElementById('item-name').value;
        const itemAmount = parseFloat(document.getElementById('item-amount').value);
        const itemColor = document.getElementById('item-color').value;
        const itemSort = parseInt(document.getElementById('item-sort').value) || items.length + 1;

        if (itemName && !isNaN(itemAmount) && itemAmount > 0) {
            items.push({ name: itemName, amount: itemAmount, color: itemColor, sort: itemSort });
            document.getElementById('item-name').value = '';
            document.getElementById('item-amount').value = '';
            document.getElementById('item-color').value = '#4CAF50';
            document.getElementById('item-sort').value = '';
            updateDisplay();
            saveToLocalStorage(); // Save after adding item
        } else {
            alert('Please enter valid item details.');
        }
    });

    // Event listener for total amount input
    totalInput.addEventListener('change', () => {
        totalAmount = parseFloat(totalInput.value) || 0;
        updateDisplay();
        saveToLocalStorage(); // Save after changing total
    });

    // Event listener for budget title input
    titleInput.addEventListener('input', () => {
        potTitle = titleInput.value;
        updateDisplay();
        saveToLocalStorage(); // Save after changing title
    });

    // Event listeners for checkbox changes
    toggleLabelsCheckbox.addEventListener('change', updateDisplay);
    toggleRemainingCheckbox.addEventListener('change', updateDisplay);

    // Load initial data from localStorage and update the display
    loadFromLocalStorage();
    updateDisplay();

</script>

</body>
</html>
